# .gitlab-ci.yml

stages:
  - test
  - deploy

variables:
  PYTHONPATH: "$CI_PROJECT_DIR/backend"

before_script:
  - echo "Running CI pipeline..."

# -------------------
# üîç Backend Tests
# -------------------
backend_tests:
  stage: test
  image: python:3.11
  script:
    - cd backend
    - pip install -r requirements.txt
    - pytest
  only:
    - dev

# -------------------
# üß™ Frontend Tests (UI)
# -------------------
frontend_tests:
  stage: test
  image: mcr.microsoft.com/playwright/python:v1.39.0-focal
  script:
    - cd frontend
    - npm install
    - npx playwright install
    - npx playwright test
  only:
    - dev

# -------------------
# üöÄ Deploy to Render (only on main)
# -------------------
deploy_to_render:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "Triggering Render frontend deployment..."
    - curl -X POST "https://api.render.com/v1/services/${FRONTEND_SERVICE_ID}/deploy" \
        -H "Authorization: Bearer ${RENDER_API_KEY}"
    - echo "Triggering Render backend deployment..."
    - curl -X POST "https://api.render.com/v1/services/${BACKEND_SERVICE_ID}/deploy" \
        -H "Authorization: Bearer ${RENDER_API_KEY}"
  only:
    - main
