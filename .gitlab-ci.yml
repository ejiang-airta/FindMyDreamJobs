# .gitlab-ci.yml

stages:
  - test
  - deploy      # This is where your artifacts move to the 'public' folder
  - prepare_mr  # This is where the Auto-MR is created

variables:
  PYTHONPATH: "$CI_PROJECT_DIR/backend"
  # Note the underscore in the backend name to match your render.yaml
  RENDER_BE_PREVIEW_URL: "https://findmydreamjobs-service-pr-$CI_MERGE_REQUEST_IID.onrender.com"
  RENDER_FE_PREVIEW_URL: "https://findmydreamjobs-pr-$CI_MERGE_REQUEST_IID.onrender.com"

before_script:
  - echo "Running CI pipeline for Merge Request..."

# -------------------
# üîç Backend Tests
# -------------------
backend_tests:
  stage: test
  image: python:3.11
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  script:
    - cd backend
    - pip install -r requirements.txt
    - pytest
  artifacts:
    when: always
    paths:
      - backend/test-results/
    expire_in: 1 week

# -------------------
# üß™ Frontend Tests (UI)
# -------------------
frontend_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.39.0-focal
  allow_failure: false  # <--- failure will block the pipeline
  rules:
    # ONLY run this when an MR is open so we have a valid PR number for the URL
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always 
  script:
    - echo "Running frontend tests against Preview PR $CI_MERGE_REQUEST_IID"
    - pwd
    - cd frontend
    - npm install
    - npx playwright install --with-deps # Ensures browsers are ready
    - echo "Starting Playwright tests against Render Previews..."
    - PLAYWRIGHT_BASE_URL=$RENDER_FE_PREVIEW_URL PLAYWRIGHT_BACKEND_URL=$RENDER_BE_PREVIEW_URL TZ="America/Los_Angeles" npx playwright test login.spec.ts app_flow.spec.ts --output=test-results
    - echo "Test completed. Checking for artifacts in $(pwd)/test-results"
    - ls -la test-results/ || echo "No results folder found"
  artifacts:  
    when: always
    paths:
      - frontend/test-results/
    expire_in: 1 week

# -------------------
# üöÄ Deploy test-results artifacts to Public folder:
# -------------------
# This job takes the results from the tests above and puts them where 
# GitLab Pages/Artifacts can easily show them to you.
deploy-artifacts:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  script:
    - mkdir -p public/test-results
    # Moves Playwright and Pytest results into the public folder for easy viewing
    - mv frontend/test-results/* public/test-results/ || echo "No frontend artifacts"
    - mv backend/test-results/* public/test-results/ || echo "No backend artifacts"
  artifacts:
    when: always
    paths:
      - public/         # GitLab Pages stores this folder
    expire_in: 30 days  # Keep artifacts for debugging

# -------------------
# üöÄ Auto-create Merge Request
# -------------------
# This job runs on the 'dev' branch push to ensure the MR exists.
# Once it creates the MR, the jobs above (backend/frontend) will trigger automatically.
auto_create_mr:
  stage: prepare_mr
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  script:  # Create a Merge Request from 'dev' to 'main' with title starting with '[render preview]' to always trigger Render preview deployments
    - >
      curl --request POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN"
      "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests?source_branch=dev&target_branch=main&remove_source_branch=false&title=%5Brender%20preview%5D%20AutoMerge%20dev%20to%20main"
  allow_failure: true # Prevents pipeline failure if MR already exists