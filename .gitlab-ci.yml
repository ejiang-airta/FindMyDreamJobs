# .gitlab-ci.yml

stages:
  - test
  - deploy

variables:
  PYTHONPATH: "$CI_PROJECT_DIR/backend"

before_script:
  - echo "Running CI pipeline..."

# -------------------
# ðŸ” Backend Tests
# -------------------
backend_tests:
  stage: test
  image: python:3.11
  script:
    - cd backend
    - pip install -r requirements.txt
    - pytest
  only:
    - dev
  artifacts:
    when: always
    paths:
      - backend/test-results/
    expire_in: 1 week

# -------------------
# ðŸ§ª Frontend Tests (UI)
# -------------------
frontend_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.39.0-focal
  script:
    - echo "Running frontend tests..."
    - pwd
    - cd frontend
    - npm install
    - npx playwright install
    - mkdir -p test-results  # Ensure the folder exists before collecting artifacts
    - echo "Testing starts"
    - npx playwright test login.spec.ts app_flow.spec.ts --output=test-results
    - echo "Test completed, checking results"
    - ls -la test-results/
    - find test-results/ -type f | head -20
    
  only:
    - dev
  artifacts:  
    when: always
    paths:
      - frontend/test-results/
    expire_in: 1 week
# -------------------
# ðŸš€ Deploy test-results artifacts to Public folder:
# -------------------
deploy-artifacts:
  stage: deploy
  script:
    - mkdir -p public/test-results
    - mv frontend/test-results/* public/test-results/ || echo "No artifacts to move"  # Prevent errors if folder is empty

  artifacts:
    when: always
    paths:
      - public/  # GitLab Pages stores this folder
    expire_in: 30 days  # Keep artifacts for debugging
  only:
    - dev # Only deploy on dev branch

# -------------------
# ðŸš€ Auto-create dev to main merge request on success pipline runs:
# -------------------
auto_merge_to_main:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - >
      curl --request POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN"
      "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests?source_branch=dev&target_branch=main&remove_source_branch=false&title=AutoMerge%20dev%20to%20main"
  only:
    - dev
  when: on_success