version: "1"

services:
  # =========================
  # Backend (FastAPI) 
  # =========================
  - type: web
    name: findmydreamjobs_service
    runtime: python
    repo: https://gitlab.com/airta.hero/Job_App
    plan: free
    region: oregon

    # ✅ Monorepo: use repo root so any change triggers preview build 
    rootDir: .
    buildCommand: cd backend && pip install -r requirements.txt
    startCommand: cd backend && ./start.sh

    envVars:
      - fromGroup: eugene-env-group
      - key: ENV
        value: production
        previewValue: preview

    previews:
      generation: automatic

  # =========================
  # Frontend (Next.js) 
  # =========================
  - type: web
    # ✅ Rename so preview URL becomes: https://findmydreamjobs-pr-XX.onrender.com
    name: findmydreamjobs
    runtime: node
    repo: https://gitlab.com/airta.hero/Job_App
    plan: free
    region: oregon

    # ✅ Monorepo: use repo root so any change triggers preview build
    rootDir: .
    buildCommand: cd frontend && npm install && npm run build
    startCommand: cd frontend && NEXTAUTH_URL=$RENDER_EXTERNAL_URL npm run start
    
    envVars:
      - fromGroup: eugene-env-group
      # Production: use internal hostname
      # Preview: use the preview backend's external URL
      - key: NEXT_PUBLIC_API_BASE_URL
        value: https://findmydreamjobs-service.onrender.com
        previewValue: https://findmydreamjobs-service-pr-${RENDER_PR_NUMBER}.onrender.com

      - key: NEXTAUTH_URL
        value: https://findmydreamjobs.onrender.com
        previewValue: https://findmydreamjobs-pr-${RENDER_PR_NUMBER}.onrender.com

      - key: NEXTAUTH_SECRET
        value: 0ywfHoMFgb7YJmgF6qewNNpFO4X7GX7Mvc6aKONxKhg=

    previews:
      generation: automatic